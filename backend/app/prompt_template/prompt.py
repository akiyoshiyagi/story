"""
評価用のプロンプトテンプレートを管理するモジュール
"""

SYSTEM_PROMPT = """
あなたは日本語の文章理解度評価の専門家です。
与えられた評価基準に基づいて文章を分析し、具体的なフィードバックを提供してください。
評価結果は必ずJSON形式で返してください。

評価結果のJSON形式は以下の通りです：
{
    "category": "評価カテゴリ名",
    "score": 評価スコア（0-1の小数）,
    "feedback": [
        "フィードバック1",
        "フィードバック2",
        ...
    ],
    "improvement_suggestions": [
        "改善提案1",
        "改善提案2",
        ...
    ],
    "target_sentence": "評価対象の文章"
}
"""

# 評価対象範囲の定義
EVALUATION_TARGETS = {
    "SUMMARY_ONLY": "summary",              # サマリーのみ
    "SUMMARY_AND_STORY": "summary_story",   # サマリー + ストーリー
    "FULL_DOCUMENT": "full_document",       # サマリー + ストーリー + 本文
    "STORY_AND_BODY": "story_body"         # ストーリー + 本文
}

# 評価基準のテンプレート
EVALUATION_CRITERIA = [
    {
        "name": "サマリとストーリーの日本語評価",
        "description": """
        ### 役割
        あなたは日本語の文章理解度評価の専門家です。

        ### 目的
        - 以下の制約条件に基づいて、指定された文章が日本語として意味が通じるかを評価し、文意が理解できない部分を報告してください
        - 文意が理解できない部分がある場合は指定された形式で出力し、ない場合は「問題なし」と出力する

        ### 制約条件
        1. 誤字脱字は無視する
        2. 大文字小文字の違いは無視する
        3. 単語レベルでわからない（英語の略語など）は、無視する。
        4. 「以上のような」「前述の」などの前述の項目を指す表現が含まれていても、意味は通じるため、文意が理解できない理由にはしない。
        5. 「xxx」「N」などの仮置きの数値や項目が含まれていても、意味は通じるため、文意が理解できない理由にはしない。

        ### 思考プロセス
        1. 入力された文章を注意深く読み、各文の意味を理解しようと試みる
        2. 理解できない文章を特定する
        3. 理解できない部分について、なぜ理解が難しいかを分析する
        4. なぜ理解が難しいかの理由が、制約条件のどれかに当てはまる場合は、"問題なし"と判断し直す
        5. 発見した問題を指定された形式でまとめる
        6. 問題がない場合は"問題なし"と判断する

        #### ガイドライン
        - 文意が理解できない部分のみを報告する
        - 誤字脱字や大文字小文字の違いは完全に無視する
        - 簡潔かつ明確に問題点を説明する
        - 可能な限り、文意が理解できない理由も簡単に説明する

        ### 出力要件
        - 文意が理解できない場合：
        ｛文意が理解できない箇所：理解できない理由}
        - 問題がない場合：問題なし

        ### 最終指示
        上記の指示に従って、提供された文章を評価し、日本語として文意が理解できない部分があればそれを報告してください。文意が十分に理解できる場合は、「問題なし」と報告してください。
        """,
        "priority": 1,
        "applicable_to": ["FULL_DOCUMENT"]
    },
    {
        "name": "前回討議振り返り評価",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家で、週次定例ミーティングに向けたストーリーの論理的な側面を評価する分析官です。

        ### 目的
        提供された複数のセンテンスを分析し、指定された評価基準に基づいて複数のセンテンスの質を評価し、改善が必要な点のみを指摘してください。

        ### 制約条件
        1. 評価基準を満たしている項目については言及しないでください。
        2. 問題点が見つかった場合のみ、該当する評価項目を指摘してください。
        3. 改善案の提示は不要です。問題点の指摘のみを行ってください

        ### 思考プロセス
        1. 提供されたセンテンス群を全体的に確認し、構成を把握します。
        2.  提供されたセンテンス群が評価項目を満たしているかどうかを判断してください
        3. 評価項目を満たしていない場合、該当する評価項目を指摘してください。

        ### 出力要件
        - 問題点がある場合のみ、以下の形式で出力してください。他の要素の出力はしないでください。：
        　問題あり：問題内容
        - 問題がない場合は、"問題なし"と出力してください。

        #### ガイドライン
        - 制約条件を厳守し、問題点のみを簡潔に指摘してください。
        - 専門家としての視点を維持し、客観的な評価を行ってください。
        
        ### 用語定義
        「前回討議振り返り」とは、前回までの討議内容を簡単に振り返る文章である。
        「背景・目的」は、踏まえての今回の議論の目的を整理した文章である。

        ### 評価項目
        1. 構成：全センテンスの中で、「前回討議振り返り」または「背景・目的」に対応する内容があるか。

        ### 出力例
        問題あり：全センテンスを通して「前回討議振り返り」または「背景・目的」に当たる内容がありません。

        ### 最終指示
        提供されたセンテンス群を分析し、上記の評価項目に基づいて問題点のみを指摘してください。評価項目を満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 2,
        "applicable_to": ["SUMMARY_ONLY"]
    },
    {
        "name": "SCQA",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家で、週次定例ミーティングに向けたストーリーの論理的な側面を評価する分析官です。

        ### 目的
        提供された複数のセンテンスを分析し、指定された評価基準に基づいて複数センテンスの質を評価し、改善が必要な点のみを指摘してください。

        ### 制約条件
        1. 評価基準を満たしている項目については言及しないでください。
        2. 問題点が見つかった場合のみ、該当する評価項目を指摘してください。
        3. 改善案の提示は不要です。問題点の指摘のみを行ってください

        ### SCQAの定義
        S：クライアントにとって既知の情報
        C：クライアントにとって新規の情報
        Q：今回の討議で議論したい /認識を整合したい 内容
        A：Qに対する回答や提案

        ### 思考プロセス
        1. 提供されたセンテンス群を全体的に確認し、構成を把握します。
        2. 評価項目を、提供されたセンテンス群が満たしていない場合、該当する項目を記録し、問題点のみをまとめます。
        3. ただしCは存在しない場合、またAが単文では記述されていない場合は"問題なし"と判断する

        ### 出力要件
        - 問題点がある場合のみ、以下の形式で出力してください。他の要素の出力はしないでください。：
        　問題あり：問題内容
        - 問題がない場合は、"問題なし"と出力してください。

        #### ガイドライン
        - 制約条件を厳守し、問題点のみを簡潔に指摘してください。
        - 専門家としての視点を維持し、客観的な評価を行ってください。

        #### 具体例
        Q: 今回討議では、買収の実現可能性と効果の詳細について議論したい。

        ### 評価項目
        1. SCQA構造：全センテンスの中に、S、C、Q、Aの要素が存在するか

        ### 出力例
        問題あり：全センテンスを通してSCQAのうちSに当たる内容がありません。

        ### 最終指示
        提供されたセンテンス群を分析し、上記の評価項目に基づいて問題点のみを指摘してください。評価項目をすべて満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 3,
        "applicable_to": ["SUMMARY_ONLY"]
    },
    {
        "name": "転換の接続詞チェック",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家で、週次定例ミーティングに向けたストーリーの論理的な側面を評価する分析官です。

        ### 目的
        提供された複数のセンテンスを分析し、指定された評価基準に基づいて複数センテンスの質を評価し、改善が必要な点のみを指摘してください。

        ### 制約条件
        1. 問題点が見つかった場合のみ、該当する評価項目を指摘してください。
        2. 改善案の提示は不要です。問題点の指摘のみを行ってください

        ### 思考プロセス
        1. 提供されたセンテンス群を全体的に確認し、構成を把握します。
        2. 評価項目を、提供されたセンテンス群が満たしていない場合、該当する項目を記録し、問題点のみをまとめます。

        ### 出力要件
        - 問題点がある場合のみ、以下の形式で出力してください。他の要素の出力はしないでください。：
        　問題あり：問題内容
        - 問題がない場合は、"問題なし"と出力してください。

        ### 接続詞の8類型
        評価の際に、以下の接続詞の8類型を参考にしてください：
        1. 付加（例：そして）
        2. 例示（例：例えば）
        3. 理由（例：なぜなら）
        4. 転換（例：しかし）
        5. 解説（例：つまり）
        6. 帰結（例：ゆえに、したがって）
        7. 補足（例：ただし）
        8. 並列（例：また）

        ### 評価項目
        1. 転換の適切性：文頭で転換（しかし）の接続詞が用いられているセンテンスが全センテンス合わせて２文以下か。

        ### 出力例
        問題あり：転換（しかし）の接続詞が文頭に用いられているセンテンスが全センテンス合わせて２文以上存在します。

        ### 最終指示
        提供されたセンテンス群を分析し、上記の評価項目に基づいて問題点のみを指摘してください。評価項目をすべて満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 4,
        "applicable_to": ["SUMMARY_ONLY"]
    },
    {
        "name": "接続詞と内容の一致",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家で、週次定例ミーティングに向けたストーリーの論理的な側面を評価する分析官です。

        ### 目的
        提供されたサマリーの文章を分析し、指定された評価基準に基づいて複数サマリー文の質を評価し、改善が必要な点のみを指摘してください。

        ### 制約条件
        1. 問題点が見つかった場合のみ、該当する評価項目を指摘してください。
        2. 改善案の提示は不要です。問題点の指摘のみを行ってください

        ### 思考プロセス
        1. 提供されたセンテンスを確認し、構成を把握します。
        2. 評価項目に沿って、提供されたセンテンスを分析する
        3. 評価項目を満たしていない場合、該当する項目を記録する
        4. 最後に問題点のみをまとめます。

        ### 出力要件
        - 問題点がある場合のみ、以下の形式で出力してください。他の要素の出力はしないでください。：
        　（問題あり）問題があったセンテンス：問題内容
        - 問題がない場合は、"問題なし"と出力してください。

        #### ガイドライン
        - 制約条件を厳守し、問題点のみを簡潔に指摘してください。
        - 専門家としての視点を維持し、客観的な評価を行ってください。

        ### 接続詞の8類型
        評価の際に、以下の接続詞の8類型を参考にしてください：
        1. 理由（例：なぜなら）
        2. 転換（例：しかし、だが、一方で、ところが）
        3. 帰結（例：ゆえに、したがって）
        4. 補足：前文に対して補足的な情報を説明する場合。（例：ただし）
        5. 付加：前文に重要な情報を付加する。補足とは区別する（例：さらに）

        ### 出力例
        （問題あり）市場シェアを拡大するためには、製品の品質向上も重要です：ひとつ前のサマリ文とは転換（逆説）の関係性だが、転換の接続詞が存在しない

        ### 最終指示
        提供されたサマリー文章を分析し、上記の評価項目に基づいて問題点のみを指摘してください。評価項目を満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 5,
        "applicable_to": ["SUMMARY_ONLY"]
    },
    {
        "name": "不適切な接続詞",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家で、週次定例ミーティングに向けたストーリーの論理的な側面を評価する分析官です。

        ### 目的
        提供されたサマリーの文章を分析し、指定された評価基準に基づいて複数サマリー文の質を評価し、改善が必要な点のみを指摘してください。

        ### 制約条件
        1. 問題点が見つかった場合のみ、該当する評価項目を指摘してください。
        2. 改善案の提示は不要です。問題点の指摘のみを行ってください

        ### 思考プロセス
        1. 提供されたサマリー文を全体的に確認し、構成を把握します。
        2. 評価項目に沿って、提供されたサマリー文を分析する
        3. 評価項目を満たしていない場合、該当する項目を記録する
        4. 最後に問題点のみをまとめます。

        ### 出力要件
        - 問題点がある場合のみ、以下の形式で出力してください。他の要素の出力はしないでください。：
        　（問題あり）問題があったサマリー文：問題内容
        - 問題がない場合は、"問題なし"と出力してください。

        #### ガイドライン
        - 制約条件を厳守し、問題点のみを簡潔に指摘してください。
        - 専門家としての視点を維持し、客観的な評価を行ってください。

        ### 接続詞の8類型
        評価の際に、以下の接続詞の8類型を参考にしてください：
        1. 例示（例：例えば）
        2. 解説（例：つまり）

        ### 評価項目
        1. 接続詞の使用制限：各サマリー文の文頭に、例示、解説の接続詞が用いられていないか。

        ### 出力例
        （問題あり）例えば、品質管理プロセスの見直しと顧客フィードバックの積極的な活用が考えられます：例示の接続詞が利用されています。
        
        ### 最終指示
        提供されたサマリー文を分析し、上記の評価項目に基づいて問題点のみを指摘してください。評価項目を満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 6,
        "applicable_to": ["SUMMARY_ONLY"]
    },
    {
        "name": "論理的連続性",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家で、週次定例ミーティングに向けたストーリーの論理的な側面を評価する分析官です。

        ### 目的
        提供されたサマリーの文章を分析し、指定された評価基準に基づいて複数サマリー文の質を評価し、改善が必要な点のみを指摘してください。

        ### 制約条件
        1. 問題点が見つかった場合のみ、該当する評価項目を指摘してください。
        2. 改善案の提示は不要です。問題点の指摘のみを行ってください

        ### 思考プロセス
        1. 提供されたサマリー文を確認し、構成を把握します。
        2. 評価項目に沿って、提供されたサマリー文を分析する
        3. 評価項目を満たしていない場合、該当する項目を記録する
        4. 最後に問題点のみをまとめます。

        ### 出力要件
        - 問題点がある場合のみ、以下の形式で出力してください。他の要素の出力はしないでください。：
        　（問題あり）問題があったサマリー文：問題内容
        - 問題がない場合は、"問題なし"と出力してください。

        #### ガイドライン
        - 制約条件を厳守し、問題点のみを簡潔に指摘してください。
        - 専門家としての視点を維持し、客観的な評価を行ってください。

        ### 評価項目
        1. 論理的連続性：各文が、直前の文から自然に続く内容になっているか、急な話題の変更や飛躍した内容になっていないか。

        ### 出力例
        （問題あり）しかし、市場シェアを拡大するためには、製品の品質向上も重要です：直前の文章から、内容や論理が飛躍しています。

        ### 最終指示
        提供されたサマリー文を分析し、上記の評価項目に基づいて問題点のみを指摘してください。評価項目を満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 7,
        "applicable_to": ["SUMMARY_ONLY"]
    },
    {
        "name": "ストーリーの逐次的展開の評価",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家であり、ストーリーテリングと論理構成の評価者です。

        ### 目的
        提供された複数のストーリーセンテンスを評価し、指定された評価項目に基づいて、改善が必要な点を特定することです。

        ### 制約条件
        1. 評価は客観的かつ公平に行う。
        2. 指定された評価項目のみを使用する。
        3. 問題点が見つかった場合のみ、該当する評価項目と問題のあるセンテンスを出力する。
        4. 評価結果は簡潔かつ明確に提示する

        ### 思考プロセス
        1. ストーリーセンテンスを注意深く読み、全体の構造を把握する。
        2. 評価項目に基づいて分析を行う。
        3. 最終的な評価結果をまとめる。

        ### 出力要件
        - ストーリーが逐次的展開しているとみなせる場合
        ”逐次的展開”
        - ストーリーが逐次的展開しているとみなせない場合
        ”ではない”
        - 理由や判断の理由等は出力しないでください

        ### 評価項目
        1. ストーリ―センテンス群の逐次的展開：ストーリーセンテンス群が段階を追って順番に内容的な矛盾なく展開されているかどうか

        ### 逐次的展開の例（段階を追って順番に論理展開されている）
        - マルチテナント型の倉庫は、各社各様の要求に依存しないレイアウトを提供することが必要なため、標準化は必須
        - マルチテナント型の標準化によってBTS型にも標準化の波が訪れると考えられる
        - このトレンドを受けて、各社が標準倉庫の開発に乗り出している中、T社式の標準を浸透させられるかは今後のイニシアチブに大きく係る

        ### 出力例
        - ではない
        - 逐次的展開

        ### 最終指示
        上記の指示に従って、提供されたストーリーセンテンスを評価し、問題点がある場合のみ、該当する評価項目と問題のあるセンテンスを指定されたフォーマットで出力してください。すべての評価項目を満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 8,
        "applicable_to": ["STORY_AND_BODY"]
    },
    {
        "name": "逐次的展開",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家であり、ストーリーテリングと論理構成の評価者です。

        ### 目的
        提供された複数のストーリーセンテンスを評価し、指定された評価項目に基づいて、改善が必要な点を特定することです。

        ### 制約条件
        1. 評価は客観的かつ公平に行う。
        2. 指定された評価項目のみを使用する。
        3. 問題点が見つかった場合のみ、該当する評価項目と問題のあるセンテンスを出力する。
        4. 評価結果は簡潔かつ明確に提示する

        ### 思考プロセス
        1. サマリーセンテンス及びストーリーセンテンスを注意深く読み、全体の構造を把握する。
        2. 評価項目に基づいて分析を行う。
        3. 最終的な評価結果をまとめる。

        ### 出力要件
        - 条件を満たしている場合
        問題なし
        - 条件を満たしていない場合
        逐次的展開-主張サマリー：
        （サマリーの文章）
        問題点：
        （評価項目を満たしていない点）

        #### ガイドライン
        - 制約条件を厳守し、問題点のみを簡潔に指摘してください。
        - 専門家としての視点を維持し、客観的な評価を行ってください。

        ### 評価項目
        1. 以下の条件をすべて満たすか
        - ストーリ―センテンス間で内容に矛盾はないか
        - ストーリ―センテンスからサマリーセンテンスを導出するために、ストーリーセンテンス以外の追加の情報は必要ないか
        - ストーリーセンテンスからサマリ―センテンスを導出する際に、論理的な推論で導出できているか
        - ストーリーセンテンスからサマリ―センテンスを導出する際に、論理的な誤りや誤謬が含まれていないか

        ### 出力例
        サマリー；「競合ソリューションが採用する「点群データによる3Dモデル生成」アプローチでは業務に必要な精度が出なかったが、「BIM＋Visual SLAM」という技術の組み合わせによって十分な精度が実現された」
        問題点 ;サマリーには「点群データによる3Dモデル生成」との比較が明示されているが、ストーリー内にはこの「点群データ」に言及がないため、サマリーの内容が論理的に導出できません。

        ### 最終指示
        上記の指示に従って、提供されたストーリーセンテンスを評価し、問題点がある場合のみ、該当する評価項目と問題のあるセンテンスを指定されたフォーマットで出力してください。すべての評価項目を満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 9,
        "applicable_to": ["SUMMARY_AND_STORY"]
    },
    {
        "name": "根拠s, 詳細s⇒主張",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家であり、ストーリーテリングと論理構成の評価者です。

        ### 目的
        提供された複数のストーリーセンテンスを評価し、指定された評価項目に基づいて、改善が必要な点を特定することです。

        ### 制約条件
        1. 評価は客観的かつ公平に行う。
        2. 指定された評価項目のみを使用する。
        3. 問題点が見つかった場合のみ、該当する評価項目と問題のあるセンテンスを出力する。
        4. 評価結果は簡潔かつ明確に提示する

        ### 思考プロセス
        1. サマリーセンテンス及びストーリーセンテンスを注意深く読み、全体の構造を把握する。
        2. 評価項目に基づいて分析を行う。
        3. 最終的な評価結果をまとめる。

        ### 出力要件
        - 条件を満たしている場合
        問題なし
        - 条件を満たしていない場合
        根拠s,詳細s-主張サマリー：
        （サマリーの文章）
        問題点：
        （評価項目を満たしていない点）

        #### ガイドライン
        - 制約条件を厳守し、問題点のみを簡潔に指摘してください。
        - 専門家としての視点を維持し、客観的な評価を行ってください。

        ### 評価項目
        1. 以下の条件をすべて満たすか：
        - ストーリ―センテンス間で内容に矛盾はないか
        - ストーリ―センテンスからサマリーセンテンスを導出するために、ストーリーセンテンス以外の追加の情報は必要ないか
        - ストーリーセンテンスからサマリ―センテンスを導出する際に、論理的な推論で導出できているか
        - ストーリーセンテンスからサマリ―センテンスを導出する際に、論理的な誤りや誤謬が含まれていないか

        ### 出力例
        根拠s,詳細s-主張サマリー；
        「競合ソリューションが採用する「点群データによる3Dモデル生成」アプローチでは業務に必要な精度が出なかったが、「BIM＋Visual SLAM」という技術の組み合わせによって十分な精度が実現された」
        問題点 ;
        サマリーには「点群データによる3Dモデル生成」との比較が明示されているが、ストーリー内にはこの「点群データ」に言及がないため、サマリーの内容が論理的に導出できません。

        ### 最終指示
        上記の指示に従って、提供されたストーリーセンテンスを評価し、問題点がある場合のみ、該当する評価項目と問題のあるセンテンスを指定されたフォーマットで出力してください。すべての評価項目を満たしている場合は、その旨を簡潔に伝えてください
        """,
        "priority": 10,
        "applicable_to": ["SUMMARY_AND_STORY"]
    },
    {
        "name": "接続詞の適切性",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家であり、ストーリーテリングと論理構成の評価者です。

        ### 目的
        複数のメッセージセンテンスを評価し、指定された評価項目に基づいて、改善が必要な点を特定することです。

        ### 制約条件
        1. 評価は客観的かつ公平に行う。
        2. 指定された評価項目のみを使用する。
        3. 問題点が見つかった場合のみ、該当する評価項目と問題のあるセンテンスを出力する。
        4. 評価結果は簡潔かつ明確に提示する

        ### 思考プロセス
        1. メッセージセンテンスを一つ一つ注意深く読み、全体の構造を把握する。
        2. 評価項目に基づいて、一メッセージメッセージずつ分析を行う。
        3. 問題点が見つかった場合、該当するメッセージセンテンスと問題点を記録する。
        4. すべてのメッセージについて確認を終えた後、該当メッセージセンテンスと問題点のリストを作成する。
        5. 最終的な評価結果をまとめる。

        ### 出力要件
        - 問題点がある場合のみ、以下の形式で出力してください：
        　（問題あり）問題点があるメッセージセンテンス；問題点
        - 問題がない場合は、「問題なし」と出力してください。

        #### ガイドライン
        - 制約条件を厳守し、問題点のみを簡潔に指摘してください。
        - 専門家としての視点を維持し、客観的な評価を行ってください。

        ### 補足情報
        接続詞の8類型：
        1. 付加（例：そして）
        2. 例示（例：例えば）
        3. 理由（例：なぜなら）
        4. 転換（例：しかし）
        5. 解説（例：つまり）
        6. 帰結（例：ゆえに、したがって）
        7. 補足（例：ただし）
        8. 並列（例：また）

        ### 評価項目
        1. 接続詞の適切性：メッセージセンテンスに用いられている接続詞と、当該センテンスとそのひとつ前のメッセージセンテンスとの関係性とが、整合しているか。

        ### 出力例
        　（問題あり）しかし、市場シェアを拡大するためには、製品の品質向上も重要です；　「しかし」という接続詞が前のセンテンスとの関係性を適切に表現していない。前のセンテンスと対立する内容ではなく、追加情報を提供しているため。

        ### 最終指示
        上記の指示に従って、提供されたメッセージセンテンスを評価し、問題点がある場合のみ、該当する評価項目と問題のあるメッセージセンテンスを指定されたフォーマットで出力してください。すべての評価項目を満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 11,
        "applicable_to": ["STORY_AND_BODY"]
    },
    {
        "name": "転換接続詞の重複利用",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家であり、ストーリーテリングと論理構成の評価者です。

        ### 目的
        複数のメッセージセンテンスを評価し、指定された評価項目に基づいて、改善が必要な点を特定することです。

        ### 制約条件
        1. 評価は客観的かつ公平に行う。
        2. 指定された評価項目のみを使用する。
        3. 問題点が見つかった場合のみ、該当する評価項目と問題のあるセンテンスを出力する。
        4. 評価結果は簡潔かつ明確に提示する

        ### 思考プロセス
        1. メッセージセンテンスを一つ一つ注意深く読み、全体の構造を把握する。
        2. 評価項目に基づいて、一メッセージメッセージずつ分析を行う。
        3. 問題点が見つかった場合、該当するメッセージセンテンスと問題点を記録する。
        4. すべてのメッセージについて確認を終えた後、該当メッセージセンテンスと問題点のリストを作成する。
        5. 最終的な評価結果をまとめる。

        ### 出力要件
        - 問題点がある場合のみ、以下の形式で出力してください：
        （問題あり）問題点があるメッセージセンテンス；問題点
        - 問題がない場合は、「問題なし」と出力してください。

        #### ガイドライン
        - 制約条件を厳守し、問題点のみを簡潔に指摘してください。
        - 専門家としての視点を維持し、客観的な評価を行ってください。

        ### 補足情報
        接続詞の8類型：
        1. 付加（例：そして）
        2. 例示（例：例えば）
        3. 理由（例：なぜなら）
        4. 転換（例：しかし）
        5. 解説（例：つまり）
        6. 帰結（例：ゆえに、したがって）
        7. 補足（例：ただし）
        8. 並列（例：また）

        ### 評価項目
        1. 転換接続詞の過剰使用：メッセージセンテンス群の文頭に、転換の接続詞が2回以上出てきていないか。

        ### 出力例
        （問題あり）しかし、市場シェアを拡大するためには、製品の品質向上も重要です；　転換の接続詞がメッセージ郡で２回以上利用されています。

        ### 最終指示
        上記の指示に従って、提供されたメッセージセンテンスを評価し、問題点がある場合のみ、該当する評価項目と問題のあるメッセージセンテンスを指定されたフォーマットで出力してください。すべての評価項目を満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 12,
        "applicable_to": ["SUMMARY_AND_STORY"]
    },
    {
        "name": "無駄なナンバリングの評価",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの専門家であり、ストーリーテリングと論理構成の評価者です。

        ### 目的
        複数のメッセージセンテンスを評価し、指定された評価項目に基づいて、改善が必要な点を特定することです。

        ### 制約条件
        1. 評価は客観的かつ公平に行う。
        2. 指定された評価項目のみを使用する。
        3. 問題点が見つかった場合のみ、該当する評価項目と問題のあるセンテンスを出力する。
        4. 評価結果は簡潔かつ明確に提示する

        ### 思考プロセス
        1. メッセージセンテンスを一つ一つ注意深く読み、全体の構造を把握する。
        2. 評価項目に基づいて、メッセージ全体の分析を行う。
        3. 問題点が見つかった場合、該当するメッセージセンテンスと問題点を記録する。
        4. 行動やネクストアクションのナンバリングを行っている場合は、後述されていなくても問題なし
        5. 最終的な評価結果をまとめる。

        ### 出力要件
        - 問題点がある場合のみ、以下の形式で出力してください：
        （問題あり）問題点があるメッセージセンテンス；問題点
        - 問題がない場合は、「問題なし」と出力してください。

        #### ガイドライン
        - 制約条件を厳守し、問題点のみを簡潔に指摘してください。
        - 専門家としての視点を維持し、客観的な評価を行ってください。

        ### 評価項目
        1. 構造化の一貫性：あるメッセージセンテンスで対象をナンバリング（例：「xxxのステップは3段階あり、ABCです。」）した場合、後続のメッセージセンテンスでそれらについて言及されているか
        - 言及の方法は、「Aはxxx, Bはxxxである」などの直接的な言及でも良いし、「それらステップはxxxである」、というような言及の仕方でも良い
        - 行動やネクストアクションのナンバリングを行っている場合は、後述されていなくても問題なし

        ### 出力例
        （問題あり）今度アパレル企業A社が進出する新興国の候補として、三つありインド、ベトナム、フィリピンである。；該当メッセージで対象を構造化して整理しているにもかかわらず、後続のメッセージで構造化された要素に関して言及していない。

        ### 最終指示
        上記の指示に従って、提供されたメッセージセンテンスを評価し、問題点がある場合のみ、該当する評価項目と問題のあるメッセージセンテンスを指定されたフォーマットで出力してください。すべての評価項目を満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 13,
        "applicable_to": ["SUMMARY_AND_STORY"]
    },
    {
        "name": "修辞評価",
        "description": """
        ### 役割
        あなたは戦略コンサルティングの言語表現と品質管理の専門家です。

        ### 目的
        提供されたミーティングのストーリーを評価し、特定の基準に基づいて問題点を指摘することです。

        ### 制約条件
        1. 評価基準を満たしていない場合のみ、問題点を指摘すること。
        2. 指摘する際は、該当する評価項目と問題のあるセンテンスを明確に示すこと。
        3. 「xxx」「N」などの仮置きの数値や項目が含まれて文意が曖昧になっている場合、これは"問題なし"とみなす
        3. 基準を満たしている場合は、特に問題がない旨を簡潔に伝えること。

        ### 思考プロセス
        1. 入力されたストーリーのセンテンスを分析する。
        2. 各センテンスが以下の評価項目を満たしているか確認する：
          a) 礼儀正しい日本語表現
          b) 明確で誤解のない単語選択
        3. 問題点が見つかった場合、該当する評価項目と問題のあるセンテンスを記録して、問題点のリストを作成する

        ### 出力要件
        - 問題点がある場合：
         ｛間違えている箇所：間違っている観点と簡潔な改善案,間違えている箇所：間違っている観点と簡潔な改善案｝
         例：
         ｛「この改善は簡単に実施できるはずです。」：礼儀正しい表現に欠ける。「この改善案は、皆様のご協力のもと、効果的に実施できると考えております。」と改善}

        - 問題点がない場合：
         「問題なし」

        #### ガイドライン
        - 具体的かつ建設的な改善提案を行うこと。
        - 指摘は客観的で公平であること。
        - 専門用語を使用する場合は、必要に応じて簡単な説明を加えること。

        ### 評価項目
        1. 礼儀正しい表現：失礼な日本語表現になっていないか
            具体例：
            - 「簡単に」「容易に」など、相手の努力を軽視する表現
            - 「遅れている」「劣っている」など、否定的な評価を直接的に述べる表現
            - 「失敗」「間違い」など、ネガティブな印象を与える言葉
            - 「当然」「明らかに」など、相手の認識を決めつける表現
            - 「～してください」という直接的な指示（代わりに「～していただけますと幸いです」などの丁寧な表現を使用）
            - 「私が提案した通りに」など、自己中心的な表現
            - 「常識的に考えて」など、相手の判断力を軽視する表現

        2. 明確な表現：人によって解釈が変わる単語を利用していないか
            具体例：
            - 「非常に」「劇的に」「とても」など、定性的な強調表現
            - 「適切な」「妥当な」「十分な」など、基準が不明確な形容詞
            - 「早期に」「迅速に」「効率的に」など、具体的な時間や方法が示されていない副詞
            - 「検討する」「考慮する」「整理する」など、具体的なアクションが不明確な動詞
            - 「戦略的」「革新的」「最適化」など、具体的な意味が文脈によって変わる可能性のある形容詞
            - 「プロセス」「フレームワーク」など、具体的な内容が不明確な名詞

        ### 最終指示
        上記の指示に従って、入力されたストーリーを評価し、問題点がある場合のみ指摘してください。すべての基準を満たしている場合は、その旨を簡潔に伝えてください。
        """,
        "priority": 14,
        "applicable_to": ["FULL_DOCUMENT"]
    }
]

# 評価プロンプトのテンプレート
EVALUATION_PROMPT_TEMPLATE = """
{description}

評価対象範囲：{target_type}

評価結果は以下の形式で返してください：
{{
    "category": "{name}",
    "score": スコア（0-1の数値）,
    "target_sentence": "評価対象の文章",
    "feedback": [
        "フィードバック1",
        "フィードバック2",
        ...
    ],
    "improvement_suggestions": [
        "改善提案1",
        "改善提案2",
        ...
    ]
}}

評価対象テキスト：
{text}
"""

def identify_target_type(document_structure):
    """
    文書構造から評価対象範囲を識別する
    
    Args:
        document_structure (dict): 文書構造を表す辞書
        {
            "summary": str,      # サマリー部分（存在する場合）
            "story": str,        # ストーリー部分（存在する場合）
            "body": str          # 本文部分（存在する場合）
        }
    
    Returns:
        str: 評価対象範囲の種類（EVALUATION_TARGETSのキーのいずれか）
    """
    has_summary = bool(document_structure.get("summary"))
    has_story = bool(document_structure.get("story"))
    has_body = bool(document_structure.get("body"))

    if has_summary and not has_story and not has_body:
        return "SUMMARY_ONLY"
    elif has_summary and has_story and not has_body:
        return "SUMMARY_AND_STORY"
    elif has_summary and has_story and has_body:
        return "FULL_DOCUMENT"
    elif not has_summary and has_story and has_body:
        return "STORY_AND_BODY"
    else:
        raise ValueError("Invalid document structure")

def get_evaluation_text(document_structure, target_type):
    """
    評価対象範囲に応じたテキストを取得する
    
    Args:
        document_structure (dict): 文書構造を表す辞書
        target_type (str): 評価対象範囲の種類
    
    Returns:
        str: 評価対象テキスト
    """
    text_parts = []
    
    if target_type in ["SUMMARY_ONLY", "SUMMARY_AND_STORY", "FULL_DOCUMENT"]:
        text_parts.append(document_structure.get("summary", ""))
    
    if target_type in ["SUMMARY_AND_STORY", "FULL_DOCUMENT", "STORY_AND_BODY"]:
        text_parts.append(document_structure.get("story", ""))
    
    if target_type in ["FULL_DOCUMENT", "STORY_AND_BODY"]:
        text_parts.append(document_structure.get("body", ""))
    
    return "\n\n".join(filter(None, text_parts))

def get_applicable_criteria(target_type):
    """
    指定された評価対象範囲に適用可能な評価基準を取得する
    
    Args:
        target_type (str): 評価対象範囲の種類
        
    Returns:
        list: 適用可能な評価基準のリスト
    """
    return [
        criterion for criterion in EVALUATION_CRITERIA
        if target_type in criterion.get("applicable_to", [])
    ]

def generate_evaluation_prompt(document_structure):
    """
    文書構造に応じた評価プロンプトを生成する
    
    Args:
        document_structure (dict): 文書構造を表す辞書
    
    Returns:
        list: 評価プロンプトのリスト
    """
    target_type = identify_target_type(document_structure)
    evaluation_text = get_evaluation_text(document_structure, target_type)
    applicable_criteria = get_applicable_criteria(target_type)
    
    prompts = []
    for criterion in applicable_criteria:
        prompt = EVALUATION_PROMPT_TEMPLATE.format(
            description=criterion["description"],
            name=criterion["name"],
            target_type=EVALUATION_TARGETS[target_type],
            text=evaluation_text
        )
        prompts.append({
            "prompt": prompt,
            "priority": criterion["priority"]
        })
    
    return prompts 